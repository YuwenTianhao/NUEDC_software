# TJC串口屏使用指南

TJC串口屏有官方资料中心，包含基本串口屏功能教程和例程下载，网址如下：

[淘晶驰资料中心 — 淘晶驰资料中心 1.1.0-2023-07-12 13:34:14 文档 (tjc1688.com)](http://wiki2.tjc1688.com/index.html)

## 页面设计

以我购买的触摸版本的TJC串口屏为例，型号为TJC3224T124_011。

### 新建工程

新建好工程后，进入设计页面:

![image-20230712202129932.png](..\串口屏\img\image-20230712202129932.png)

左侧工具箱中包含多种控件，其中比较常用的有【文本控件】用于显示文本，【图片控件】用于显示图片，【按钮控件】用于实现按键功能。但有些控件是看不见的，比如定时器等控件，位于底部的特殊控件栏。

### 控件事件

控件事件，指控件被操作时要执行的功能。例如触摸被按下：对应名称叫做【按下事件】，触摸被按下后弹起：对应名称叫做【弹起事件】。

### 控件属性

控件属性是控件本身的设置项，比如想要显示文本，选择文本控件后，需要通过编辑控件属性来完成显示内容、字体颜色等方面的设计。

每个控件都有很多属性可以设置。选中控件,可以在左下角看到属性栏，其中绿色项是可以被修改的。

![image-20230712204225566](..\串口屏\img\image-20230712204225566.png)

### 新建字库

在编辑文本时，需要用到字库，点击工具中的【字库制作】并将生成的字库文件添加到左侧的字库栏中即可。（图片等同理）

![image-20230712205537572](..\串口屏\img\image-20230712205537572.png)

![image-20230712205647027](..\串口屏\img\image-20230712205647027.png)

### 页面切换

通过编辑【按钮控件】的弹起事件可以实现页面切换。例如下图中按下按钮后将跳转到main页面。

```
page main
```

![image-20230712204917313](..\串口屏\img\image-20230712204917313.png)

### 下载程序至串口屏

使用USB转TTL模块与串口屏连接后，点击上方菜单的【下载】按钮即可完成程序的烧录，第一次程序烧录的时间可能较长，需要耐心等待。

## 串口屏与单片机之间的通信

### 单片机向串口屏通信

首先需要在【Program.s】中配置好串口屏与单片机的波特率。

![image-20230713105001706](..\串口屏\img\image-20230713105001706.png)

将【tjc_usart_hmi.h】，【tjc_usart_hmi.c】文件加入工程。

在main.c的 USER CODE BEGIN Includes 和 USER CODE END Includes 之间插入

```c
#include "tjc_usart_hmi.h"
```

在main.h的 USER CODE BEGIN ET 和 USER CODE END ET 之间声明 huart1 会在其他文件中调用



![image-20230713112942405](..\串口屏\img\image-20230713112942405.png)

切换到main.c，在 USER CODE BEGIN 2 和 USER CODE END 2 之间初始化环形缓冲区和打开串口接收中断。

```
initRingBuff();		//初始化环形缓冲区
HAL_UART_Receive_IT(&huart2, RxBuff, 1);	//打开串口接收中断
```

此时使用函数TJCPrintf，即可实现单片机向串口屏的通信。需要注意的是，修改文本控件的【txt】属性时需要加入英文双引号""。

```
 TJCPrintf("main.t2.txt=\"%lf\"",INA226_data.Shunt_Current);//将串口屏页面【main】中的【t2】文本修改为当前电流大小
```

需要注意的是，如果之前使用过printf函数，需要注释掉，避免向串口屏通信时发生干扰。

### 串口屏向单片机通信

详细的说明请见官方网站的教程。[串口屏发送数据给单片机 — 淘晶驰资料中心 1.1.0-2023-07-12 13:34:14 文档 (tjc1688.com)](http://wiki2.tjc1688.com/debug/usart_protocol/tjc2mcu.html)

#### 上位机程序的设计

![image-20230713115745234](..\串口屏\img\image-20230713115745234.png)

在【后初始化事件】中加入代码，实现“进入此界面后，向单片机发送：55 01 ff ff ff  ”的功能。其中“55”为帧头，“ff ff ff”为帧尾，便于后续解码。

```
printh 55 01 ff ff ff
```

#### 设计解码代码

设计相关代码解码即可。

```
/**
* @brief 读取串口屏的返回值
* @return 0xff为无效值，0x03为初始页面，0x01为电流检测页面, 0x02为电压检测页面
*/
uint8_t status()
{
    uint8_t status_now;
    while(usize >= 5)
    {
//校验帧头帧尾是否匹配
        if(u(0) != 0x55 || u(2) != 0xff || u(3) != 0xff || u(4) != 0xff)
        {
//不匹配删除1字节
            udelete(1);
        }else
        {
//匹配，跳出循环
            break;
        }
    }
//进行解析
    if(usize >= 5 && u(0) == 0x55 && u(2) == 0xff && u(3) == 0xff && u(4) == 0xff)
    {
        status_now = u(1);
        udelete(5);
        return status_now;
    }
    else
    {
        return 0xff;
    }
}
```

